# Arca Compatibility Feature - Backend Requirements

**Version:** 1.2
**Date:** 2025-11-25
**Status:** Draft - For Backend Team Review

---

## Related Documentation

**This feature works alongside the Charts feature.** Backend team should implement both:

| Doc | Feature | Endpoints |
|-----|---------|-----------|
| `docs/natal-chart-visualization-plan.md` | Charts Tab - user's own natal/transit charts | `get_natal_chart`, `get_transit_chart` |
| `docs/compatibility-backend-prd.md` (this doc) | Connections Tab - compare with others | `get_compatibility`, `get_natal_chart_for_connection`, invite flow |

Both features share Kerykeion infrastructure and coordinate system.

---

## Overview

iOS needs a compatibility endpoint that compares user's natal chart with another person's birth data. Returns synastry aspects, weighted scores by category, and LLM-generated interpretations.

**Key constraints:**
- ONE LLM call per relationship
- Returns ALL THREE MODES in single response
- iOS handles all caching
- No backend-side user data storage for connections

---

## Why We're Building This (Competitive Context)

| Competitor | Problem |
|------------|---------|
| **Co-Star** | Shows data but "roasts" - users don't learn anything useful |
| **The Pattern** | Black box - hides astrology, just gives labels like "Soulmate" |
| **Dating apps** | Sun sign only - useless |

**Arca's approach:** Show real aspects + explain what they mean in plain language. Full transparency. User can tap "Why?" to see exact aspects driving any score. Three modes (Romantic/Friendship/Co-worker) give different scores for same pairing.

---

## LLM Generation Scope

**Generated ONCE per relationship call:**

| Content | Generated by |
|---------|--------------|
| Aspect list (planets, orbs, types) | Math (Kerykeion) |
| Scores (overall 0-100, category -100 to +100) | Weighted algorithm |
| Relationship verb (one per mode = 3 total) | LLM |
| Category summaries (6 per mode = 18 total) | LLM |
| Aspect interpretations (one per aspect) | LLM |
| Composite summary | LLM |

**All three modes returned in single response.** iOS caches everything. Mode switching is instant on client - no additional backend calls.

---

## Decisions Made

| Decision | Choice |
|----------|--------|
| Score range - overall | 0-100 (higher = more compatible) |
| Score range - categories | -100 to +100 (negative = challenging) |
| Caching | iOS caches, backend is stateless |
| Mode response | All three modes in single response |
| Composite chart | Included |
| Rate limiting | 10 connections per user per day |
| Missing data handling | Omit what we can't calculate, return prompts for user to add more info |

---

## Existing Infrastructure to Leverage

- `DailyHoroscope.relationshipWeather` - Already generates daily relationship energy. iOS displays this in Compatibility tab. No additional backend work.
- `get_natal_chart` - Extend to work for arbitrary birth data (not just logged-in user).
- Kerykeion - Already used for chart calculations.

---

## Requirement 1: Compatibility Endpoint

### Endpoint
`POST /get_compatibility`

### Input
```json
{
  "user_id": "firebase_uid",
  "connection_birth_data": {
    "birth_date": "1990-05-15",
    "birth_time": "14:30",
    "birth_city": "New York",
    "birth_country": "US"
  }
}
```

`birth_time` is optional. If missing:
- Omit Moon-dependent categories (Emotional) from response entirely
- Omit Moon/ASC aspects from response
- Set composite Moon/Rising to null
- Add to `missing_data_prompts`: "Add birth time to see Emotional compatibility"

`birth_city`/`birth_country` are optional. If missing:
- Omit house-dependent data from response
- Planet signs still calculated correctly
- Add to `missing_data_prompts`: "Add birth location for full analysis"

**Principle: Don't show what we can't calculate accurately. Prompt user to add more info instead.**

### Output
```json
{
  "romantic": {
    "mode": "romantic",
    "overall_score": 78,
    "relationship_verb": "You spark each other",
    "categories": [
      {
        "id": "emotional",
        "name": "Emotional",
        "score": 65,
        "summary": "You feel safe with each other, though you process feelings differently.",
        "aspect_ids": ["uuid1", "uuid2", "uuid3"]
      },
      {
        "id": "communication",
        "name": "Communication",
        "score": 82,
        "summary": "You get each other without trying too hard.",
        "aspect_ids": ["uuid4", "uuid5"]
      },
      {
        "id": "attraction",
        "name": "Attraction",
        "score": 45,
        "summary": "There's chemistry, but it builds slowly.",
        "aspect_ids": ["uuid6", "uuid7"]
      },
      {
        "id": "values",
        "name": "Values",
        "score": -20,
        "summary": "You want different things - this needs conversation.",
        "aspect_ids": ["uuid8"]
      },
      {
        "id": "growth",
        "name": "Growth",
        "score": 70,
        "summary": "You push each other to be better.",
        "aspect_ids": ["uuid9", "uuid10"]
      },
      {
        "id": "stability",
        "name": "Stability",
        "score": 55,
        "summary": "Solid foundation, but takes work to maintain.",
        "aspect_ids": ["uuid11"]
      }
    ],
    "missing_data_prompts": []
  },
  "friendship": {
    "mode": "friendship",
    "overall_score": 85,
    "relationship_verb": "You click",
    "categories": [...],
    "missing_data_prompts": []
  },
  "coworker": {
    "mode": "coworker",
    "overall_score": 72,
    "relationship_verb": "You balance each other",
    "categories": [...],
    "missing_data_prompts": []
  },
  "aspects": [
    {
      "id": "uuid1",
      "user_planet": "moon",
      "their_planet": "venus",
      "aspect_type": "trine",
      "aspect_symbol": "triangle",
      "orb": 3.5,
      "interpretation": "Your emotional needs align with how they show love.",
      "is_harmonious": true
    },
    {
      "id": "uuid2",
      "user_planet": "sun",
      "their_planet": "saturn",
      "aspect_type": "square",
      "aspect_symbol": "square",
      "orb": 2.1,
      "interpretation": "They can feel critical of your core self at times.",
      "is_harmonious": false
    }
  ],
  "composite_summary": {
    "composite_sign": "Libra",
    "composite_sun": "Libra",
    "composite_moon": "Cancer",
    "composite_rising": null,
    "summary": "Together you act like a Libra couple - seeking balance, avoiding conflict.",
    "strengths": ["Natural diplomacy", "Shared aesthetics"],
    "challenges": ["Decision paralysis", "Conflict avoidance"]
  },
  "calculated_at": "2025-11-25T14:30:00Z"
}
```

**If birth time missing**, response would omit Emotional category and Moon aspects:
```json
{
  "romantic": {
    "categories": [
      // Emotional category OMITTED
      { "id": "communication", ... },
      { "id": "attraction", ... },
      ...
    ],
    "missing_data_prompts": ["Add birth time to see Emotional compatibility"]
  },
  "aspects": [
    // Moon aspects OMITTED - only Sun, Mercury, Venus, Mars, etc. aspects included
  ],
  "composite_summary": {
    "composite_moon": null,  // null because we can't calculate
    ...
  }
}
```

### Categories Required

| ID | Name | What drives it |
|----|------|----------------|
| `emotional` | Emotional | Moon-Moon, Moon-Venus, Moon-IC |
| `communication` | Communication | Mercury-Mercury, Mercury-Moon |
| `attraction` | Attraction | Venus-Mars, Venus-Ascendant, Mars-Mars |
| `values` | Values | Venus-Venus, Jupiter aspects, 2nd/7th houses |
| `growth` | Growth | Saturn aspects, Pluto aspects, Nodes |
| `stability` | Stability | Saturn-Sun, Saturn-Moon, 4th house overlays |

### Mode Weighting

Same aspects, different weights per mode:

| Mode | Heavy weight on |
|------|-----------------|
| Romantic | Venus-Mars, Moon-Moon, Sun-Moon, Saturn |
| Friendship | Mercury, Moon, Jupiter, Sun |
| Co-worker | Mercury, Saturn, Mars, 10th house |

### Relationship Verbs

LLM picks one per mode based on dominant aspect patterns:
- "You click"
- "You challenge each other"
- "You ground each other"
- "You spark each other"
- "You balance each other"
- "You push each other to grow"

### Rate Limiting

- 10 new compatibility calculations per user per day
- Cached results don't count against limit
- Return HTTP 429 if exceeded

---

## Requirement 2: Natal Chart for Connection

Extend existing `get_natal_chart` or provide new endpoint for arbitrary birth data.

### Endpoint
`POST /get_natal_chart_for_connection`

### Input
```json
{
  "birth_date": "1990-05-15",
  "birth_time": "14:30",
  "birth_city": "New York",
  "birth_country": "US"
}
```

### Output
```json
{
  "chart": { /* Same BirthChart structure as user's chart */ },
  "has_exact_chart": true
}
```

If `birth_time` is null:
```json
{
  "chart": { /* Chart calculated with noon default - Moon/ASC/houses will be approximate */ },
  "has_exact_chart": false
}
```

iOS uses `has_exact_chart` to know whether to request compatibility with full data or partial.

---

## Requirement 3: Invite Link Flow

User shares link so someone else can enter their own birth data.

### Generate Link

`POST /create_invite_link`

```json
{
  "user_id": "firebase_uid",
  "connection_name": "Sarah"
}

Response:
{
  "invite_id": "abc123",
  "invite_url": "https://arca-app.com/invite/abc123",
  "expires_at": "2025-12-25T00:00:00Z"
}
```

Invite expires in 30 days.

### Check Status

`GET /check_invite_status/{invite_id}`

```json
Response (pending):
{
  "status": "pending",
  "birth_data": null
}

Response (completed):
{
  "status": "completed",
  "birth_data": {
    "birth_date": "1992-03-20",
    "birth_time": "09:15",
    "birth_city": "Los Angeles",
    "birth_country": "US"
  }
}

Response (expired):
{
  "status": "expired",
  "birth_data": null
}
```

### Web Page Required

Simple page at `arca-app.com/invite/{code}`:
- Shows: "[Name] wants to check your compatibility on Arca"
- Collects: Name, birth date, birth time (optional), birth location
- On submit: stores data, marks invite completed
- Privacy: Data only accessible by inviting user via check_invite_status

---

## Voice & Tone for LLM Interpretations

**Be a wise friend. Not a fortune teller, not a professor.**

| Don't say | Say instead |
|-----------|-------------|
| "Synastry indicates harmonious lunar aspects" | "Your Moons work well together - you feel emotionally safe" |
| "Challenging Saturn contacts" | "Saturn here means you might hold back at first" |
| "Venus-Mars conjunction suggests physical compatibility" | "There's real chemistry here" |

Short sentences. Plain words. Say what it MEANS, not just what it IS. Be honest about challenges without doom.

---

## Edge Cases

### Missing Birth Time
- Omit Emotional category (Moon-dependent)
- Omit all Moon/ASC aspects from response
- Set composite Moon/Rising to null
- Include prompt: "Add birth time to see Emotional compatibility"

### Missing Birth Location
- Omit house overlay data
- Sun/Moon/planet aspects still calculated (location only affects houses)
- Include prompt: "Add birth location for full analysis"

### Birth Data Update
- If iOS sends same user_id + different birth data, it's a new calculation
- No backend state to update - each call is independent
- iOS clears its cache and requests fresh

### Rate Limit Exceeded
- Return HTTP 429
- Include `Retry-After` header with seconds until reset
- Body: `{"error": "rate_limit_exceeded", "message": "Maximum 10 compatibility checks per day"}`

---

## Existing `relationshipWeather` Field

`DailyHoroscope` already has `relationshipWeather: String?` generated daily. iOS displays this in Compatibility tab as "Today's Vibe."

**No additional backend work needed.** Future enhancement could be connection-specific weather, but not for this release.
